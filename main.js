const t=document.getElementsByClassName("input_video5")[0],a=document.getElementsByClassName("output5")[0],e=document.getElementsByClassName("output6")[0],o=document.getElementsByClassName("control5")[0],r=a.getContext("2d"),n=e.getContext("2d"),l=new Array(300).fill(0),s=new Array(15).fill(0),i=new Array(60).fill(0);var c,d,h,m,f=0,u=0,p=0,y="----";let C=0,x="----",v="----";const F=300,g=new Array(F).fill(0),A=new Array(F).fill(0),E=new Array(F).fill(0);var M=0;let w,_,L,T="----",N=0,b=0,R=0;function S(t,a="int"){const e=t.length,o=new Array(e);for(let a=0;a<e;a++)o[a]={x:t[a].x,y:t[a].y};return o}function k(t){const a={};let e;t.forEach((t=>a[t]=(a[t]||0)+1));let o=0;for(const t in a)a[t]>o&&(e=t,o=a[t]);return+e}function P(t,a){const e=-178;return(t+=a)>179&&(t=e+(t-179)-1),t<e&&(t=179-(e-t)+1),t}function O(t,a){const e=a.x-t.x,o=a.y-t.y,r=a.z-t.z;return Math.sqrt(e*e+o*o+r*r)}function I(t,a,e){const o=(a*a+e*e-t*t)/(2*a*e);return Math.acos(o)*(180/Math.PI)}function D(t){const a=clamp(t.from.z+.5,0,1);return`rgba(0, ${255*a}, ${255*(1-a)}, 1)`}const H=new FaceMesh({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.1/${t}`});H.onResults((function(t){0,0,0,0;var a=[],e=[1,33,263,61,291,199];r.save(),r.clearRect(0,0,o.width,o.height);var w,_=t.image.width,L=t.image.height,O=1.28*L,I=_/2,D=L/2,H=cv.matFromArray(3,3,cv.CV_64FC1,[O,0,I,0,O,D,0,0,1]),B=cv.matFromArray(4,1,cv.CV_64FC1,[.1318020374,-.1550007612,-.0071350401,-.0096747708]);if(t.multiFaceLandmarks){for(const o of t.multiFaceLandmarks){drawConnectors(r,o,FACEMESH_TESSELATION,{color:"#C0C0C070",lineWidth:1});for(const t of e){var $=o[t],V=$.x*_,z=$.y*L;a.push(V),a.push(z)}const d=S(o);var U=(Math.hypot(d[160].x-d[144].x,d[160].y-d[144].y)+Math.hypot(d[158].x-d[153].x,d[158].y-d[153].y)+Math.hypot(d[385].x-d[380].x,d[385].y-d[380].y)+Math.hypot(d[387].x-d[373].x,d[387].y-d[373].y))/4/((Math.hypot(d[33].x-d[133].x,d[33].y-d[133].y)+Math.hypot(d[362].x-d[263].x,d[362].y-d[263].y))/2);f<=300?(1,f+=1,l.shift(),l.push(U),U<=.12?(c=1,p=0===u?1:0,u=1):(c=0,p=1===u?1:0,u=0),s.shift(),s.push(c),c):(0,U<l.reduce(((t,a)=>t+a),0)/300*.65?(c=1,p=0,u=1):(c=0,p=1===u?1:0,u=0),s.shift(),s.push(c),c),s.reduce(((t,a)=>t+a),0)>5?(1,y="EYE_CLOSE"):(0,y="----"),i.shift(),i.push(p),i.reduce(((t,a)=>t+a),0)>6?1:0;if(t.multiFaceLandmarks){const t=Math.hypot(d[12].x-d[14].x,d[12].y-d[14].y);t>.02?t>.035?1==c?(1,y="YAWNING"):(0,y="----"):1:0}n.fillText(y,15,100)}if(a.length>0){var j=new cv.Mat,G=new cv.Mat;const t=e.length,o=cv.matFromArray(t,2,cv.CV_64FC1,a);var K=cv.matFromArray(6,3,cv.CV_64FC1,[0,-1.126865,7.475604,-4.445859,2.663991,3.173422,4.445859,2.663991,3.173422,-2.456206,-4.342621,4.283884,2.456206,-4.342621,4.283884,0,-9.403378,4.264492]);if(cv.solvePnP(K,o,H,B,j,G,!1,cv.SOLVEPNP_ITERATIVE)){var W=cv.Mat.zeros(3,3,cv.CV_64FC1);const t=new cv.Mat;cv.Rodrigues(j,W,t);var q=Math.sqrt(W.data64F[0]*W.data64F[0]+W.data64F[3]*W.data64F[3]);if(q<1e-6?(V=Math.atan2(-W.data64F[5],W.data64F[4]),z=Math.atan2(-W.data64F[6],q),w=0):(V=Math.atan2(W.data64F[7],W.data64F[8]),z=Math.atan2(-W.data64F[6],q),w=Math.atan2(W.data64F[3],W.data64F[0])),N=Number((z/Math.PI*180).toFixed(2)),b=Number((V/Math.PI*180).toFixed(2)),R=Number((w/Math.PI*180).toFixed(2)),M<F&&(g.shift(),g.push(Math.round(N)),A.shift(),A.push(Math.round(R)),E.shift(),E.push(Math.round(b)),M++),M==F&&(C=1,h=k(g),k(A),m=k(E),n.fillStyle="black",n.font="bold 20px Cambria",h<25&&h>-25?(v="Optimal",n.fillText("Cam Position : Optimal",15,65)):(v="Non Optimal",n.fillText("Cam Position : Non Optimal",15,65))),1==C?(x="Auto Tuning Complete",n.fillText("Auto Tuning : Complete",15,30)):(x="Auto Tuning In Progress",n.fillText("Auto Tuning : In Progress",15,30)),N>65||N<-65)d=1;else{if(d=0,C){var Y=h+35,J=h-35,Q=P(m,20),X=P(m,-20);b>0&&b<X?(1,T="HEAD_UP"):b<0&&b>Q?(1,T="HEAD_DOWN"):N>Y&&R<45&&R>-45?(1,T="HEAD_RIGHT_TURN"):N<J&&R<45&&R>-45?(1,T="HEAD_LEFT_TURN"):T="----"}n.fillText(T,15,135)}n.fillStyle="black",n.font="bold 20px Cambria"}}n.fillStyle="Black",n.font="bold 20px Cambria",j.delete(),G.delete()}else d=1;n.restore(),r.restore()}));const B=new Pose({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.2/${t}`});B.onResults((function(t){if(n.save(),n.clearRect(0,0,e.width,e.height),r.save(),r.clearRect(0,0,a.width,a.height),r.drawImage(t.image,0,0,a.width,a.height),t.poseLandmarks){landmarks=t.poseLandmarks;const e=landmarks[0],o=landmarks[8],l=landmarks[7],s=[O(o,e),O(l,e),O(o,l)],i=I(s[0],s[1],s[2]),c=I(s[1],s[2],s[0]),h=I(s[2],s[0],s[1]);w=c,_=i,L=h,n.fillStyle="black",n.font="bold 20px Cambria",d&&Math.abs(c-i)>=30&&(LRB=w>_,RLB=_>w,T=RLB?"HEAD_RIGHT_TURN_POSE":LRB?"HEAD_LEFT_TURN_POSE":"----",n.fillStyle="black",n.font="bold 20px Cambria",n.fillText(T,15,135)),drawConnectors(r,t.poseLandmarks,POSE_CONNECTIONS,{color:t=>{const e=a.width*t.from.x,o=a.height*t.from.y,n=a.width*t.to.x,l=a.height*t.to.y,s=clamp(t.from.z+.5,0,1),i=clamp(t.to.z+.5,0,1),c=r.createLinearGradient(e,o,n,l);return c.addColorStop(0,`rgba(0, ${255*s}, ${255*(1-s)}, 1)`),c.addColorStop(1,`rgba(0, ${255*i}, ${255*(1-i)}, 1)`),c}}),drawLandmarks(r,Object.values(POSE_LANDMARKS_LEFT).map((a=>t.poseLandmarks[a])),{color:D,fillColor:"#000000"}),drawLandmarks(r,Object.values(POSE_LANDMARKS_RIGHT).map((a=>t.poseLandmarks[a])),{color:D,fillColor:"#000000"}),drawLandmarks(r,Object.values(POSE_LANDMARKS_NEUTRAL).map((a=>t.poseLandmarks[a])),{color:D,fillColor:"#000000"})}n.restore(),r.restore()}));new Camera(t,{onFrame:async()=>{await B.send({image:t}),await H.send({image:t})},width:480,height:480}).start();